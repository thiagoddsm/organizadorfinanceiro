<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Semanal - Regina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-item:hover {
            background-color: #f9fafb;
        }
        .completed {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .month-checkbox {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
        }
        #feedback-message {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Controle financeiro - IBM</h1>
            <p class="text-md text-gray-600 mt-1">Registro da lançamentos e arquivos</p>
             <div class="mt-4 text-sm text-gray-500">
                <span id="auth-status" class="font-semibold text-red-500">Conectando...</span> | 
                <span>ID de Usuário: <span id="user-id" class="font-mono">N/A</span></span>
            </div>
        </header>

        <!-- Mensagem de Erro -->
        <div id="error-container" class="hidden p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50" role="alert">
            <!-- Mensagens de erro serão inseridas aqui -->
        </div>

        <!-- Seção de Ferramentas Úteis -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-3 text-center">Ferramentas Úteis</h2>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                <a href="https://thiagoddsm.github.io/ImportEklesia/" target="_blank" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-center">
                    Import Eklesia OFX/CSV
                </a>
                <a href="https://www.ofxfacil.com.br/pdf-ofx" target="_blank" class="w-full sm:w-auto bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-center">
                    Gerador de OFX
                </a>
            </div>
        </div>

        <!-- Seção de Status dos Bancos -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Status de Atualização dos Bancos</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-700" id="bank-status-table">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="px-4 py-3">Banco</th>
                            <th scope="col" class="px-4 py-3">Última Atualização</th>
                            <th scope="col" class="px-4 py-3">Observações</th>
                            <th scope="col" class="px-4 py-3 text-center">Verificado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Linhas da tabela serão preenchidas via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Seção de Controle de Extratos no Drive -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Controle de Extratos no Drive</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-700" id="drive-status-table">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <!-- Cabeçalho dos meses preenchido via JS -->
                    </thead>
                    <tbody id="drive-status-body">
                        <!-- Conteúdo da tabela preenchido via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Seção de Tarefas Semanais -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Checklist de Tarefas da Semana</h2>
            <div id="task-list" class="space-y-6">
                <!-- Tarefas serão inseridas aqui via JS -->
            </div>
        </div>
        
        <!-- Botões de Ação -->
        <div class="flex justify-end items-center mt-8 space-x-4">
            <span id="feedback-message" class="text-green-600 font-medium opacity-0"></span>
            <button id="clear-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                Limpar Dados
            </button>
            <button id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                Salvar Progresso
            </button>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import necessary functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE ---
        // As credenciais abaixo são para o seu projeto Firebase.
        // IMPORTANTE: Para que a aplicação funcione, as regras de segurança do Firestore
        // no seu projeto precisam de permitir leitura e escrita.
        const firebaseConfig = {
          apiKey: "AIzaSyCLzKaQ2EMTHPSqd8QyOz_ctJ2p8_ZEuqU",
          authDomain: "organizacaofinanceiro-f0784.firebaseapp.com",
          projectId: "organizacaofinanceiro-f0784",
          storageBucket: "organizacaofinanceiro-f0784.firebasestorage.app",
          messagingSenderId: "156036781954",
          appId: "1:156036781954:web:ed5c3210d8a6df03e6619b"
        };

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM ELEMENTS ---
        const bankTableBody = document.querySelector('#bank-status-table tbody');
        const driveTableHead = document.querySelector('#drive-status-table thead');
        const driveTableBody = document.getElementById('drive-status-body');
        const taskListContainer = document.getElementById('task-list');
        const saveButton = document.getElementById('save-button');
        const clearButton = document.getElementById('clear-button');
        const feedbackMessage = document.getElementById('feedback-message');
        const authStatusEl = document.getElementById('auth-status');
        const userIdEl = document.getElementById('user-id');
        const errorContainer = document.getElementById('error-container');

        let banks = [];
        const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        
        function getInitialData() {
            return {
                banks: [
                    { name: 'Santander', status: '2024-08-20', obs: 'Pente fino pendente (saldo não bate).', checked: false, drive: Array(12).fill(false) },
                    { name: 'Bradesco', status: '', obs: '', checked: false, drive: Array(12).fill(false) },
                    { name: 'Bradesco Niterói', status: '', obs: '', checked: false, drive: Array(12).fill(false) },
                    { name: 'Caixa', status: '2024-04-29', obs: '', checked: false, drive: Array(12).fill(false) },
                    { name: 'Mercado Pago', status: '', obs: 'Verificar se está em dia.', checked: false, drive: Array(12).fill(false) },
                    { name: 'Cora', status: '', obs: 'Verificar R$50,00 a mais.', checked: false, drive: Array(12).fill(false) },
                    { name: 'PagBank', status: '', obs: 'Itens não conciliados pendentes.', checked: false, drive: Array(12).fill(false) },
                    { name: 'Caixa (Espécie)', status: '', obs: '', checked: false, drive: Array(12).fill(false) }
                ],
                tasks: {} // Tasks will be populated dynamically from the DOM on save
            };
        }

        const tasksStructure = {
            'Segunda-feira': [{ id: 'seg1', text: 'Lançamentos do Caixa Espécie' }, { id: 'seg2', text: 'Reunião de equipe' }],
            'Terça-feira': [{ id: 'ter1', text: 'Lançamentos e conciliação do Mercado Pago' }, { id: 'ter2', text: 'Lançamentos e conciliação do Santander' }],
            'Quinta-feira': [{ id: 'qui1', text: 'Lançamentos e conciliação do Cora' }, { id: 'qui2', text: 'Lançamentos e conciliação da Caixa' }, { id: 'qui3', text: 'Lançamentos e conciliação do Bradesco (ambas)' }],
            'Sexta-feira': [{ id: 'sex1', text: 'Lançamentos e conciliação do Caixa Espécie' }, { id: 'sex2', text: 'Lançamentos e conciliação do PagBank' }]
        };

        // --- RENDER FUNCTIONS ---
        function renderBankTable(bankData) {
            bankTableBody.innerHTML = '';
            bankData.forEach((bank, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">${bank.name}</td>
                    <td class="px-4 py-3"><input type="date" id="date-${index}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2" value="${bank.status}"></td>
                    <td class="px-4 py-3"><input type="text" id="obs-${index}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2" placeholder="Adicionar observação..." value="${bank.obs}"></td>
                    <td class="px-4 py-3 text-center"><input type="checkbox" id="check-${index}" class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"></td>
                `;
                bankTableBody.appendChild(row);
                document.getElementById(`check-${index}`).checked = bank.checked;
            });
        }
        
        function renderDriveTable(bankData) {
            let headerHTML = '<tr><th scope="col" class="px-4 py-3">Banco</th>';
            months.forEach(month => { headerHTML += `<th scope="col" class="px-2 py-3 text-center">${month}</th>`; });
            headerHTML += '</tr>';
            driveTableHead.innerHTML = headerHTML;

            driveTableBody.innerHTML = '';
            bankData.forEach((bank, bankIndex) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                let rowHTML = `<td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">${bank.name}</td>`;
                months.forEach((_, monthIndex) => {
                    rowHTML += `<td class="px-2 py-3 text-center"><input type="checkbox" id="drive-${bankIndex}-${monthIndex}" class="month-checkbox text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"></td>`;
                });
                row.innerHTML = rowHTML;
                driveTableBody.appendChild(row);

                const driveData = bank.drive || Array(12).fill(false);
                driveData.forEach((isChecked, monthIndex) => {
                    document.getElementById(`drive-${bankIndex}-${monthIndex}`).checked = isChecked;
                });
            });
        }

        function renderTaskList(taskData = {}) {
            taskListContainer.innerHTML = '';
            for (const day in tasksStructure) {
                const dayContainer = document.createElement('div');
                dayContainer.innerHTML = `<h3 class="text-lg font-semibold text-gray-800">${day}</h3>`;
                const taskGroup = document.createElement('div');
                taskGroup.className = 'mt-2 space-y-3';
                tasksStructure[day].forEach(task => {
                    const savedTask = taskData[task.id] || { checked: false, obs: '' };
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item flex items-center justify-between p-3 rounded-lg border border-gray-200';
                    taskItem.innerHTML = `
                        <div class="flex items-center"><input id="${task.id}-check" type="checkbox" class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"><label for="${task.id}-check" class="ml-3 text-sm font-medium text-gray-900 ${savedTask.checked ? 'completed' : ''}">${task.text}</label></div>
                        <input type="text" id="${task.id}-obs" class="ml-4 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-1/2 p-2" placeholder="Obs..." value="${savedTask.obs}">
                    `;
                    taskGroup.appendChild(taskItem);
                    const checkbox = taskItem.querySelector(`#${task.id}-check`);
                    checkbox.checked = savedTask.checked;
                    const label = taskItem.querySelector(`label[for="${task.id}-check"]`);
                    checkbox.addEventListener('change', () => { label.classList.toggle('completed', checkbox.checked); });
                });
                dayContainer.appendChild(taskGroup);
                taskListContainer.appendChild(dayContainer);
            }
        }

        function showFeedback(message) {
            feedbackMessage.textContent = message;
            feedbackMessage.style.opacity = '1';
            setTimeout(() => { feedbackMessage.style.opacity = '0'; }, 2500);
        }
        
        function displayError(message) {
            errorContainer.innerHTML = message;
            errorContainer.classList.remove('hidden');
        }

        // --- DATA HANDLING FUNCTIONS (FIRESTORE) ---
        async function saveData() {
            const docRef = doc(db, "financeControl", "sharedState");
            const dataToSave = { banks: [], tasks: {} };
            const initialBankData = getInitialData().banks;

            initialBankData.forEach((bank, index) => {
                const driveStatus = months.map((_, monthIndex) => document.getElementById(`drive-${index}-${monthIndex}`).checked);
                dataToSave.banks.push({
                    name: bank.name,
                    status: document.getElementById(`date-${index}`).value,
                    obs: document.getElementById(`obs-${index}`).value,
                    checked: document.getElementById(`check-${index}`).checked,
                    drive: driveStatus
                });
            });

            for (const day in tasksStructure) {
                tasksStructure[day].forEach(task => {
                    dataToSave.tasks[task.id] = {
                        checked: document.getElementById(`${task.id}-check`).checked,
                        obs: document.getElementById(`${task.id}-obs`).value
                    };
                });
            }

            try {
                await setDoc(docRef, dataToSave, { merge: true });
                showFeedback('Progresso salvo na nuvem!');
            } catch (error) {
                console.error("Error saving data: ", error);
                showFeedback('Erro ao salvar!');
            }
        }

        async function clearData() {
            const docRef = doc(db, "financeControl", "sharedState");
            try {
                await setDoc(docRef, getInitialData());
                showFeedback('Dados na nuvem foram resetados!');
            } catch (error) {
                console.error("Error clearing data: ", error);
                showFeedback('Erro ao limpar dados!');
            }
        }

        // --- AUTHENTICATION & REAL-TIME LISTENER ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in.
                authStatusEl.textContent = 'Conectado em Tempo Real';
                authStatusEl.className = 'font-semibold text-green-600';
                userIdEl.textContent = user.uid;
                errorContainer.classList.add('hidden'); // Esconde o erro se a autenticação for bem-sucedida

                const docRef = doc(db, "financeControl", "sharedState");
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        banks = data.banks || getInitialData().banks;
                        renderBankTable(banks);
                        renderDriveTable(banks);
                        renderTaskList(data.tasks);
                    } else {
                        console.log("No such document! Creating with initial data.");
                        const initialData = getInitialData();
                        banks = initialData.banks;
                        renderBankTable(banks);
                        renderDriveTable(banks);
                        renderTaskList(initialData.tasks);
                        saveData();
                    }
                }, (error) => { // Adiciona o handler de erro aqui
                    console.error("Snapshot error: ", error);
                    if (error.code === 'permission-denied') {
                        const rulesUrl = `https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/rules`;
                        displayError(`
                            <b class="font-bold">Erro de Permissão:</b> A base de dados não permite o acesso. Para corrigir, siga estes passos:
                            <ol class="list-decimal list-inside mt-2 space-y-1">
                                <li>Abra as <a href="${rulesUrl}" target="_blank" class="font-bold underline">Regras do Firestore</a> do seu projeto Firebase.</li>
                                <li>Substitua todo o conteúdo do editor de regras pelo código abaixo:</li>
                            </ol>
                            <pre class="bg-gray-200 p-2 rounded mt-2 text-xs overflow-x-auto"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</code></pre>
                            <p class="mt-2">Depois de colar, clique em <b>"Publicar"</b> e recarregue esta página.</p>
                        `);
                    }
                });

            } else {
                // User is signed out.
                authStatusEl.textContent = 'Desconectado';
                authStatusEl.className = 'font-semibold text-red-500';
                userIdEl.textContent = 'N/A';
            }
        });

        // --- INITIALIZATION ---
        async function initializeAppAndAuth() {
            // Render the initial structure of ALL components before connecting to Firebase.
            const initialData = getInitialData();
            banks = initialData.banks;
            renderBankTable(banks);
            renderDriveTable(banks);
            renderTaskList(initialData.tasks);
            
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                authStatusEl.textContent = 'Falha na autenticação';
                if (error.code === 'auth/invalid-api-key') {
                    displayError("<b>Erro de Configuração:</b> A 'API Key' do Firebase é inválida. Verifique se as credenciais no código estão corretas.");
                } else if (error.code === 'auth/network-request-failed') {
                    // FIX: Added specific error handling for network/CORS issues.
                    const authUrl = `https://console.firebase.google.com/project/${firebaseConfig.projectId}/authentication/settings`;
                    displayError(`
                        <b class="font-bold">Erro de Rede ou Domínio não Autorizado:</b> Não foi possível ligar ao Firebase.
                        <ol class="list-decimal list-inside mt-2 space-y-1">
                            <li>Verifique a sua ligação à internet.</li>
                            <li>Se o problema persistir, precisa de autorizar o domínio <b>${window.location.hostname}</b> no seu projeto Firebase.</li>
                            <li>Vá a <a href="${authUrl}" target="_blank" class="font-bold underline">Authentication > Settings > Authorized domains</a> no seu painel Firebase.</li>
                            <li>Clique em "Adicionar domínio" e insira <b>${window.location.hostname}</b>.</li>
                        </ol>
                    `);
                }
            }
        }

        initializeAppAndAuth();

        saveButton.addEventListener('click', saveData);
        clearButton.addEventListener('click', clearData);

    </script>
</body>
</html>
